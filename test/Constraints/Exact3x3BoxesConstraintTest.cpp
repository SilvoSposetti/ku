#include "Exact3x3BoxesConstraint.hpp"

#include "ConstraintTestHelpers.hpp"

#include <doctest.h>

TEST_SUITE("Constraints") {

  TEST_CASE("Exact3x3BoxesConstraint") {

    SUBCASE("Members") {
      ConstraintTestHelpers::memberChecks<Exact3x3BoxesConstraint<PuzzleIntrinsics<{0, 0, 0}>{}>>();
    }

    SUBCASE("Implicit Option Coverage") {
      // Cases with zero
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 0, 0, 9);
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 0, 3, 9);
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 6, 0, 9);
      // Regular cases
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 3, 3, 9);
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 3, 9, 9);
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 9, 3, 9);
      GENERATE_SUBCASE(Exact3x3BoxesConstraint, 15, 6, 9);
    }

    SUBCASE("Not supported") {
      // Rows are not a multiple of 3
      CHECK(!Exact3x3BoxesConstraint<PuzzleIntrinsics<{2, 3, 9}>{}>().supportsPuzzle());
      CHECK(!Exact3x3BoxesConstraint<PuzzleIntrinsics<{11, 3, 9}>{}>().supportsPuzzle());
      // Columns are not a multiple of 3
      CHECK(!Exact3x3BoxesConstraint<PuzzleIntrinsics<{6, 4, 9}>{}>().supportsPuzzle());
      CHECK(!Exact3x3BoxesConstraint<PuzzleIntrinsics<{6, 7, 9}>{}>().supportsPuzzle());
      // Digits are not exactly 9
      CHECK(!Exact3x3BoxesConstraint<PuzzleIntrinsics<{6, 3, 8}>{}>().supportsPuzzle());
      CHECK(!Exact3x3BoxesConstraint<PuzzleIntrinsics<{6, 3, 10}>{}>().supportsPuzzle());
    }

    SUBCASE("Explicit Options") {
      SUBCASE("3x3x9") {
        constexpr auto intrinsics = PuzzleIntrinsics<{3, 3, 9}>{};
        ConstraintTestHelpers::checkConstraintOptions<intrinsics, 1, 0>(
            Exact3x3BoxesConstraint<intrinsics>(),
            9,
            std::vector<Option<1>>{
                {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8}, {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8}, {0}, {1}, {2},
                {3}, {4}, {5}, {6}, {7}, {8}, {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8}, {0}, {1}, {2}, {3}, {4}, {5},
                {6}, {7}, {8}, {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8}, {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8},
                {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8}, {0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8},
            },
            0,
            {});
      }
      SUBCASE("3x12x9") {
        constexpr auto intrinsics = PuzzleIntrinsics<{3, 12, 9}>{};
        ConstraintTestHelpers::checkConstraintOptions<intrinsics, 1, 0>(
            Exact3x3BoxesConstraint<intrinsics>(),
            36,
            std::vector<Option<1>>{
                {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},
                {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {9},  {10}, {11}, {12}, {13}, {14}, {15},
                {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14},
                {15}, {16}, {17}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22},
                {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {27}, {28}, {29}, {30},
                {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29},
                {30}, {31}, {32}, {33}, {34}, {35}, {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},
                {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {9},
                {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17},
                {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25},
                {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24},
                {25}, {26}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32},
                {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {0},  {1},  {2},  {3},  {4},
                {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},
                {4},  {5},  {6},  {7},  {8},  {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11},
                {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {18}, {19},
                {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18},
                {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35},
                {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34},
                {35},
            },
            0,
            {});
      }

      SUBCASE("9x9x9") {
        constexpr auto intrinsics = PuzzleIntrinsics<{9, 9, 9}>{};
        ConstraintTestHelpers::checkConstraintOptions<intrinsics, 1, 0>(
            Exact3x3BoxesConstraint<intrinsics>(),
            81,
            std::vector<Option<1>>{
                {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},
                {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {9},  {10}, {11}, {12}, {13}, {14}, {15},
                {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14},
                {15}, {16}, {17}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22},
                {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {0},  {1},  {2},  {3},
                {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},
                {3},  {4},  {5},  {6},  {7},  {8},  {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10},
                {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {18},
                {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26},
                {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},
                {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},  {7},  {8},  {0},  {1},  {2},  {3},  {4},  {5},  {6},
                {7},  {8},  {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14},
                {15}, {16}, {17}, {9},  {10}, {11}, {12}, {13}, {14}, {15}, {16}, {17}, {18}, {19}, {20}, {21}, {22},
                {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21}, {22}, {23}, {24}, {25}, {26}, {18}, {19}, {20}, {21},
                {22}, {23}, {24}, {25}, {26}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29},
                {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {36}, {37},
                {38}, {39}, {40}, {41}, {42}, {43}, {44}, {36}, {37}, {38}, {39}, {40}, {41}, {42}, {43}, {44}, {36},
                {37}, {38}, {39}, {40}, {41}, {42}, {43}, {44}, {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52}, {53},
                {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52}, {53}, {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52},
                {53}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33},
                {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {36}, {37}, {38}, {39}, {40}, {41},
                {42}, {43}, {44}, {36}, {37}, {38}, {39}, {40}, {41}, {42}, {43}, {44}, {36}, {37}, {38}, {39}, {40},
                {41}, {42}, {43}, {44}, {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52}, {53}, {45}, {46}, {47}, {48},
                {49}, {50}, {51}, {52}, {53}, {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52}, {53}, {27}, {28}, {29},
                {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28}, {29}, {30}, {31}, {32}, {33}, {34}, {35}, {27}, {28},
                {29}, {30}, {31}, {32}, {33}, {34}, {35}, {36}, {37}, {38}, {39}, {40}, {41}, {42}, {43}, {44}, {36},
                {37}, {38}, {39}, {40}, {41}, {42}, {43}, {44}, {36}, {37}, {38}, {39}, {40}, {41}, {42}, {43}, {44},
                {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52}, {53}, {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52},
                {53}, {45}, {46}, {47}, {48}, {49}, {50}, {51}, {52}, {53}, {54}, {55}, {56}, {57}, {58}, {59}, {60},
                {61}, {62}, {54}, {55}, {56}, {57}, {58}, {59}, {60}, {61}, {62}, {54}, {55}, {56}, {57}, {58}, {59},
                {60}, {61}, {62}, {63}, {64}, {65}, {66}, {67}, {68}, {69}, {70}, {71}, {63}, {64}, {65}, {66}, {67},
                {68}, {69}, {70}, {71}, {63}, {64}, {65}, {66}, {67}, {68}, {69}, {70}, {71}, {72}, {73}, {74}, {75},
                {76}, {77}, {78}, {79}, {80}, {72}, {73}, {74}, {75}, {76}, {77}, {78}, {79}, {80}, {72}, {73}, {74},
                {75}, {76}, {77}, {78}, {79}, {80}, {54}, {55}, {56}, {57}, {58}, {59}, {60}, {61}, {62}, {54}, {55},
                {56}, {57}, {58}, {59}, {60}, {61}, {62}, {54}, {55}, {56}, {57}, {58}, {59}, {60}, {61}, {62}, {63},
                {64}, {65}, {66}, {67}, {68}, {69}, {70}, {71}, {63}, {64}, {65}, {66}, {67}, {68}, {69}, {70}, {71},
                {63}, {64}, {65}, {66}, {67}, {68}, {69}, {70}, {71}, {72}, {73}, {74}, {75}, {76}, {77}, {78}, {79},
                {80}, {72}, {73}, {74}, {75}, {76}, {77}, {78}, {79}, {80}, {72}, {73}, {74}, {75}, {76}, {77}, {78},
                {79}, {80}, {54}, {55}, {56}, {57}, {58}, {59}, {60}, {61}, {62}, {54}, {55}, {56}, {57}, {58}, {59},
                {60}, {61}, {62}, {54}, {55}, {56}, {57}, {58}, {59}, {60}, {61}, {62}, {63}, {64}, {65}, {66}, {67},
                {68}, {69}, {70}, {71}, {63}, {64}, {65}, {66}, {67}, {68}, {69}, {70}, {71}, {63}, {64}, {65}, {66},
                {67}, {68}, {69}, {70}, {71}, {72}, {73}, {74}, {75}, {76}, {77}, {78}, {79}, {80}, {72}, {73}, {74},
                {75}, {76}, {77}, {78}, {79}, {80}, {72}, {73}, {74}, {75}, {76}, {77}, {78}, {79}, {80},
            },
            0,
            {});
      }
    }

    SUBCASE("Drawing") {

      SUBCASE("9x9x9") {
        constexpr auto space = PuzzleSpace{9, 9, 9};
        const auto expected = R"(<g id="Exact 3x3 Box" fill="transparent" stroke="black" stroke-width="2.667">
<rect x="0" y="0" width="333.333" height="333.333"/>
<rect x="333.333" y="0" width="333.333" height="333.333"/>
<rect x="666.667" y="0" width="333.333" height="333.333"/>
<rect x="0" y="333.333" width="333.333" height="333.333"/>
<rect x="333.333" y="333.333" width="333.333" height="333.333"/>
<rect x="666.667" y="333.333" width="333.333" height="333.333"/>
<rect x="0" y="666.667" width="333.333" height="333.333"/>
<rect x="333.333" y="666.667" width="333.333" height="333.333"/>
<rect x="666.667" y="666.667" width="333.333" height="333.333"/>
</g>)";
        ConstraintTestHelpers::checkConstraintSvg<space, Exact3x3BoxesConstraint<PuzzleIntrinsics<space>{}>>(expected);
      }

      SUBCASE("15x6x9") {
        constexpr auto space = PuzzleSpace{15, 6, 9};
        const auto expected = R"(<g id="Exact 3x3 Box" fill="transparent" stroke="black" stroke-width="2.667">
<rect x="0" y="0" width="500" height="500"/>
<rect x="500" y="0" width="500" height="500"/>
<rect x="0" y="500" width="500" height="500"/>
<rect x="500" y="500" width="500" height="500"/>
<rect x="0" y="1000" width="500" height="500"/>
<rect x="500" y="1000" width="500" height="500"/>
<rect x="0" y="1500" width="500" height="500"/>
<rect x="500" y="1500" width="500" height="500"/>
<rect x="0" y="2000" width="500" height="500"/>
<rect x="500" y="2000" width="500" height="500"/>
</g>)";
        ConstraintTestHelpers::checkConstraintSvg<space, Exact3x3BoxesConstraint<PuzzleIntrinsics<space>{}>>(expected);
      }
    }
  }
}
