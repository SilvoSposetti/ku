#include "constraintTemplated/utilities/NeighborPatternUtilities.hpp"

#include <doctest.h>

/** Templated function to help with the checks.
 * @tparam puzzle The puzzle
 * @tparam patternSize The size of the pattern
 * @tparam optionSize The size of the options
 * @param pattern The array containing the unique pattern used to generate the option
 * @param expectedForwardPattern The expected pattern looking in the 'forward' direction
 * @param expectedBackwardPattern The expected pattern looking opposite to the 'forward' direction
 * @param expectedUniqueNeighbors The expected count of non-torus unique neighbors found for all cells in row-major
 * order
 * @param expectedNonTorusOptions The expected non-torus options for all possibilities of the puzzle
 * @param expectedTorusOptions The expected torus options for all possibilities of the puzzle
 */
template <PuzzleIntrinsics puzzle, std::size_t patternSize, OptionId optionSize>
constexpr void check(const std::array<std::pair<int32_t, int32_t>, patternSize>& pattern,
                     const std::array<std::pair<int32_t, int32_t>, patternSize / 2>& expectedForwardPattern,
                     const std::array<std::size_t, puzzle.rows * puzzle.columns>& expectedUniqueNeighbors,
                     const std::array<Option<optionSize>, puzzle.allPossibilities().size()>& expectedNonTorusOptions,
                     const std::array<Option<optionSize>, puzzle.allPossibilities().size()>& expectedTorusOptions) {

  CHECK(NeighborPatternUtilities::isValidPattern(pattern));

  const auto forwardPattern = NeighborPatternUtilities::sortedForwardPattern(pattern);
  CHECK_EQ(forwardPattern, expectedForwardPattern);

  std::size_t uniqueIndex = 0;
  for (const auto& rowIndex : puzzle.rowIndices) {
    for (const auto& columnIndex : puzzle.columnIndices) {
      const auto computedCount =
          NeighborPatternUtilities::countUniquePatternConnectionsUpTo<puzzle, false>(pattern, rowIndex, columnIndex);
      CHECK_EQ(computedCount, expectedUniqueNeighbors.at(uniqueIndex));
      uniqueIndex++;
    }
  }

  std::size_t nonTorusOptionIndex = 0;
  for (const auto& [rowIndex, columnIndex, digit] : puzzle.allPossibilities()) {
    const auto computedNonTorusOption =
        NeighborPatternUtilities::computePatternOption<puzzle, patternSize, optionSize, false>(
            rowIndex, columnIndex, digit, pattern);
    CHECK_EQ(computedNonTorusOption, expectedNonTorusOptions.at(nonTorusOptionIndex));
    nonTorusOptionIndex++;
  }

  std::size_t torusOptionIndex = 0;
  for (const auto& [rowIndex, columnIndex, digit] : puzzle.allPossibilities()) {
    const auto computedTorusOption =
        NeighborPatternUtilities::computePatternOption<puzzle, patternSize, optionSize, true>(
            rowIndex, columnIndex, digit, pattern);
    CHECK_EQ(computedTorusOption, expectedTorusOptions.at(torusOptionIndex));
    torusOptionIndex++;
  }
}

TEST_CASE("Neighbor Pattern Utilities") {
  constexpr auto puzzle = PuzzleIntrinsics<{3, 4, 9}>();

  SUBCASE("Patterns") {
    SUBCASE("Left-Right Pattern") {
      check<puzzle, 2>(
          std::array<std::pair<int32_t, int32_t>, 2>{std::make_pair(0, -1), {0, 1}},
          std::array<std::pair<int32_t, int32_t>, 1>{std::make_pair(0, 1)},
          std::array<std::size_t, 12>{0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9},
          std::array<Option<2>, puzzle.allPossibilities().size()>{
              Option<2>{0}, {1},      {2},      {3},      {4},      {5},      {6},      {7},      {8},      {0, 9},
              {1, 10},      {2, 11},  {3, 12},  {4, 13},  {5, 14},  {6, 15},  {7, 16},  {8, 17},  {9, 18},  {10, 19},
              {11, 20},     {12, 21}, {13, 22}, {14, 23}, {15, 24}, {16, 25}, {17, 26}, {18},     {19},     {20},
              {21},         {22},     {23},     {24},     {25},     {26},     {27},     {28},     {29},     {30},
              {31},         {32},     {33},     {34},     {35},     {27, 36}, {28, 37}, {29, 38}, {30, 39}, {31, 40},
              {32, 41},     {33, 42}, {34, 43}, {35, 44}, {36, 45}, {37, 46}, {38, 47}, {39, 48}, {40, 49}, {41, 50},
              {42, 51},     {43, 52}, {44, 53}, {45},     {46},     {47},     {48},     {49},     {50},     {51},
              {52},         {53},     {54},     {55},     {56},     {57},     {58},     {59},     {60},     {61},
              {62},         {54, 63}, {55, 64}, {56, 65}, {57, 66}, {58, 67}, {59, 68}, {60, 69}, {61, 70}, {62, 71},
              {63, 72},     {64, 73}, {65, 74}, {66, 75}, {67, 76}, {68, 77}, {69, 78}, {70, 79}, {71, 80}, {72},
              {73},         {74},     {75},     {76},     {77},     {78},     {79},     {80},
          },
          std::array<Option<2>, puzzle.allPossibilities().size()>{
              Option<2>{0, 9}, {1, 10},   {2, 11},   {3, 12},   {4, 13},   {5, 14},   {6, 15},   {7, 16},   {8, 17},
              {9, 18},         {10, 19},  {11, 20},  {12, 21},  {13, 22},  {14, 23},  {15, 24},  {16, 25},  {17, 26},
              {18, 27},        {19, 28},  {20, 29},  {21, 30},  {22, 31},  {23, 32},  {24, 33},  {25, 34},  {26, 35},
              {0, 27},         {1, 28},   {2, 29},   {3, 30},   {4, 31},   {5, 32},   {6, 33},   {7, 34},   {8, 35},
              {36, 45},        {37, 46},  {38, 47},  {39, 48},  {40, 49},  {41, 50},  {42, 51},  {43, 52},  {44, 53},
              {45, 54},        {46, 55},  {47, 56},  {48, 57},  {49, 58},  {50, 59},  {51, 60},  {52, 61},  {53, 62},
              {54, 63},        {55, 64},  {56, 65},  {57, 66},  {58, 67},  {59, 68},  {60, 69},  {61, 70},  {62, 71},
              {36, 63},        {37, 64},  {38, 65},  {39, 66},  {40, 67},  {41, 68},  {42, 69},  {43, 70},  {44, 71},
              {72, 81},        {73, 82},  {74, 83},  {75, 84},  {76, 85},  {77, 86},  {78, 87},  {79, 88},  {80, 89},
              {81, 90},        {82, 91},  {83, 92},  {84, 93},  {85, 94},  {86, 95},  {87, 96},  {88, 97},  {89, 98},
              {90, 99},        {91, 100}, {92, 101}, {93, 102}, {94, 103}, {95, 104}, {96, 105}, {97, 106}, {98, 107},
              {72, 99},        {73, 100}, {74, 101}, {75, 102}, {76, 103}, {77, 104}, {78, 105}, {79, 106}, {80, 107},
          });
    }

    SUBCASE("Plus Pattern") {
      check<puzzle, 4>(std::array<std::pair<int32_t, int32_t>, 4>{std::make_pair(0, -1), {0, 1}, {1, 0}, {-1, 0}},
                       std::array<std::pair<int32_t, int32_t>, 2>{std::make_pair(0, 1), {1, 0}},
                       std::array<std::size_t, 12>{0, 2, 4, 6, 7, 9, 11, 13, 14, 15, 16, 17},
                       std::array<Option<4>, puzzle.allPossibilities().size()>{
                           Option<4>{0, 9},
                           {1, 10},
                           {2, 11},
                           {3, 12},
                           {4, 13},
                           {5, 14},
                           {6, 15},
                           {7, 16},
                           {8, 17},
                           {0, 18, 27},
                           {1, 19, 28},
                           {2, 20, 29},
                           {3, 21, 30},
                           {4, 22, 31},
                           {5, 23, 32},
                           {6, 24, 33},
                           {7, 25, 34},
                           {8, 26, 35},
                           {18, 36, 45},
                           {19, 37, 46},
                           {20, 38, 47},
                           {21, 39, 48},
                           {22, 40, 49},
                           {23, 41, 50},
                           {24, 42, 51},
                           {25, 43, 52},
                           {26, 44, 53},
                           {36, 54},
                           {37, 55},
                           {38, 56},
                           {39, 57},
                           {40, 58},
                           {41, 59},
                           {42, 60},
                           {43, 61},
                           {44, 62},
                           {9, 63, 72},
                           {10, 64, 73},
                           {11, 65, 74},
                           {12, 66, 75},
                           {13, 67, 76},
                           {14, 68, 77},
                           {15, 69, 78},
                           {16, 70, 79},
                           {17, 71, 80},
                           {27, 63, 81, 90},
                           {28, 64, 82, 91},
                           {29, 65, 83, 92},
                           {30, 66, 84, 93},
                           {31, 67, 85, 94},
                           {32, 68, 86, 95},
                           {33, 69, 87, 96},
                           {34, 70, 88, 97},
                           {35, 71, 89, 98},
                           {45, 81, 99, 108},
                           {46, 82, 100, 109},
                           {47, 83, 101, 110},
                           {48, 84, 102, 111},
                           {49, 85, 103, 112},
                           {50, 86, 104, 113},
                           {51, 87, 105, 114},
                           {52, 88, 106, 115},
                           {53, 89, 107, 116},
                           {54, 99, 117},
                           {55, 100, 118},
                           {56, 101, 119},
                           {57, 102, 120},
                           {58, 103, 121},
                           {59, 104, 122},
                           {60, 105, 123},
                           {61, 106, 124},
                           {62, 107, 125},
                           {72, 126},
                           {73, 127},
                           {74, 128},
                           {75, 129},
                           {76, 130},
                           {77, 131},
                           {78, 132},
                           {79, 133},
                           {80, 134},
                           {90, 126, 135},
                           {91, 127, 136},
                           {92, 128, 137},
                           {93, 129, 138},
                           {94, 130, 139},
                           {95, 131, 140},
                           {96, 132, 141},
                           {97, 133, 142},
                           {98, 134, 143},
                           {108, 135, 144},
                           {109, 136, 145},
                           {110, 137, 146},
                           {111, 138, 147},
                           {112, 139, 148},
                           {113, 140, 149},
                           {114, 141, 150},
                           {115, 142, 151},
                           {116, 143, 152},
                           {117, 144},
                           {118, 145},
                           {119, 146},
                           {120, 147},
                           {121, 148},
                           {122, 149},
                           {123, 150},
                           {124, 151},
                           {125, 152},
                       },
                       std::array<Option<4>, puzzle.allPossibilities().size()>{
                           Option<4>{0, 9, 18, 81}, {1, 10, 19, 82},      {2, 11, 20, 83},      {3, 12, 21, 84},
                           {4, 13, 22, 85},         {5, 14, 23, 86},      {6, 15, 24, 87},      {7, 16, 25, 88},
                           {8, 17, 26, 89},         {18, 27, 36, 99},     {19, 28, 37, 100},    {20, 29, 38, 101},
                           {21, 30, 39, 102},       {22, 31, 40, 103},    {23, 32, 41, 104},    {24, 33, 42, 105},
                           {25, 34, 43, 106},       {26, 35, 44, 107},    {36, 45, 54, 117},    {37, 46, 55, 118},
                           {38, 47, 56, 119},       {39, 48, 57, 120},    {40, 49, 58, 121},    {41, 50, 59, 122},
                           {42, 51, 60, 123},       {43, 52, 61, 124},    {44, 53, 62, 125},    {0, 54, 63, 135},
                           {1, 55, 64, 136},        {2, 56, 65, 137},     {3, 57, 66, 138},     {4, 58, 67, 139},
                           {5, 59, 68, 140},        {6, 60, 69, 141},     {7, 61, 70, 142},     {8, 62, 71, 143},
                           {72, 81, 90, 153},       {73, 82, 91, 154},    {74, 83, 92, 155},    {75, 84, 93, 156},
                           {76, 85, 94, 157},       {77, 86, 95, 158},    {78, 87, 96, 159},    {79, 88, 97, 160},
                           {80, 89, 98, 161},       {90, 99, 108, 171},   {91, 100, 109, 172},  {92, 101, 110, 173},
                           {93, 102, 111, 174},     {94, 103, 112, 175},  {95, 104, 113, 176},  {96, 105, 114, 177},
                           {97, 106, 115, 178},     {98, 107, 116, 179},  {108, 117, 126, 189}, {109, 118, 127, 190},
                           {110, 119, 128, 191},    {111, 120, 129, 192}, {112, 121, 130, 193}, {113, 122, 131, 194},
                           {114, 123, 132, 195},    {115, 124, 133, 196}, {116, 125, 134, 197}, {72, 126, 135, 207},
                           {73, 127, 136, 208},     {74, 128, 137, 209},  {75, 129, 138, 210},  {76, 130, 139, 211},
                           {77, 131, 140, 212},     {78, 132, 141, 213},  {79, 133, 142, 214},  {80, 134, 143, 215},
                           {9, 144, 153, 162},      {10, 145, 154, 163},  {11, 146, 155, 164},  {12, 147, 156, 165},
                           {13, 148, 157, 166},     {14, 149, 158, 167},  {15, 150, 159, 168},  {16, 151, 160, 169},
                           {17, 152, 161, 170},     {27, 162, 171, 180},  {28, 163, 172, 181},  {29, 164, 173, 182},
                           {30, 165, 174, 183},     {31, 166, 175, 184},  {32, 167, 176, 185},  {33, 168, 177, 186},
                           {34, 169, 178, 187},     {35, 170, 179, 188},  {45, 180, 189, 198},  {46, 181, 190, 199},
                           {47, 182, 191, 200},     {48, 183, 192, 201},  {49, 184, 193, 202},  {50, 185, 194, 203},
                           {51, 186, 195, 204},     {52, 187, 196, 205},  {53, 188, 197, 206},  {63, 144, 198, 207},
                           {64, 145, 199, 208},     {65, 146, 200, 209},  {66, 147, 201, 210},  {67, 148, 202, 211},
                           {68, 149, 203, 212},     {69, 150, 204, 213},  {70, 151, 205, 214},  {71, 152, 206, 215},
                       });
    }

    SUBCASE("Moore Pattern") {
      check<puzzle, 8>(
          std::array<std::pair<int32_t, int32_t>, 8>{
              std::make_pair(1, 0), {1, -1}, {0, -1}, {-1, -1}, {-1, 0}, {-1, 1}, {0, 1}, {1, 1}},
          std::array<std::pair<int32_t, int32_t>, 4>{std::make_pair(0, 1), {1, 1}, {1, 0}, {1, -1}},
          std::array<std::size_t, 12>{0, 3, 7, 11, 13, 16, 20, 24, 26, 27, 28, 29},
          std::array<Option<8>, puzzle.allPossibilities().size()>{
              Option<8>{0, 9, 18},
              {1, 10, 19},
              {2, 11, 20},
              {3, 12, 21},
              {4, 13, 22},
              {5, 14, 23},
              {6, 15, 24},
              {7, 16, 25},
              {8, 17, 26},
              {0, 27, 36, 45, 54},
              {1, 28, 37, 46, 55},
              {2, 29, 38, 47, 56},
              {3, 30, 39, 48, 57},
              {4, 31, 40, 49, 58},
              {5, 32, 41, 50, 59},
              {6, 33, 42, 51, 60},
              {7, 34, 43, 52, 61},
              {8, 35, 44, 53, 62},
              {27, 63, 72, 81, 90},
              {28, 64, 73, 82, 91},
              {29, 65, 74, 83, 92},
              {30, 66, 75, 84, 93},
              {31, 67, 76, 85, 94},
              {32, 68, 77, 86, 95},
              {33, 69, 78, 87, 96},
              {34, 70, 79, 88, 97},
              {35, 71, 80, 89, 98},
              {63, 99, 108},
              {64, 100, 109},
              {65, 101, 110},
              {66, 102, 111},
              {67, 103, 112},
              {68, 104, 113},
              {69, 105, 114},
              {70, 106, 115},
              {71, 107, 116},
              {18, 54, 117, 126, 135},
              {19, 55, 118, 127, 136},
              {20, 56, 119, 128, 137},
              {21, 57, 120, 129, 138},
              {22, 58, 121, 130, 139},
              {23, 59, 122, 131, 140},
              {24, 60, 123, 132, 141},
              {25, 61, 124, 133, 142},
              {26, 62, 125, 134, 143},
              {9, 45, 90, 117, 144, 153, 162, 171},
              {10, 46, 91, 118, 145, 154, 163, 172},
              {11, 47, 92, 119, 146, 155, 164, 173},
              {12, 48, 93, 120, 147, 156, 165, 174},
              {13, 49, 94, 121, 148, 157, 166, 175},
              {14, 50, 95, 122, 149, 158, 167, 176},
              {15, 51, 96, 123, 150, 159, 168, 177},
              {16, 52, 97, 124, 151, 160, 169, 178},
              {17, 53, 98, 125, 152, 161, 170, 179},
              {36, 81, 108, 144, 180, 189, 198, 207},
              {37, 82, 109, 145, 181, 190, 199, 208},
              {38, 83, 110, 146, 182, 191, 200, 209},
              {39, 84, 111, 147, 183, 192, 201, 210},
              {40, 85, 112, 148, 184, 193, 202, 211},
              {41, 86, 113, 149, 185, 194, 203, 212},
              {42, 87, 114, 150, 186, 195, 204, 213},
              {43, 88, 115, 151, 187, 196, 205, 214},
              {44, 89, 116, 152, 188, 197, 206, 215},
              {72, 99, 180, 216, 225},
              {73, 100, 181, 217, 226},
              {74, 101, 182, 218, 227},
              {75, 102, 183, 219, 228},
              {76, 103, 184, 220, 229},
              {77, 104, 185, 221, 230},
              {78, 105, 186, 222, 231},
              {79, 106, 187, 223, 232},
              {80, 107, 188, 224, 233},
              {135, 171, 234},
              {136, 172, 235},
              {137, 173, 236},
              {138, 174, 237},
              {139, 175, 238},
              {140, 176, 239},
              {141, 177, 240},
              {142, 178, 241},
              {143, 179, 242},
              {126, 162, 207, 234, 243},
              {127, 163, 208, 235, 244},
              {128, 164, 209, 236, 245},
              {129, 165, 210, 237, 246},
              {130, 166, 211, 238, 247},
              {131, 167, 212, 239, 248},
              {132, 168, 213, 240, 249},
              {133, 169, 214, 241, 250},
              {134, 170, 215, 242, 251},
              {153, 198, 225, 243, 252},
              {154, 199, 226, 244, 253},
              {155, 200, 227, 245, 254},
              {156, 201, 228, 246, 255},
              {157, 202, 229, 247, 256},
              {158, 203, 230, 248, 257},
              {159, 204, 231, 249, 258},
              {160, 205, 232, 250, 259},
              {161, 206, 233, 251, 260},
              {189, 216, 252},
              {190, 217, 253},
              {191, 218, 254},
              {192, 219, 255},
              {193, 220, 256},
              {194, 221, 257},
              {195, 222, 258},
              {196, 223, 259},
              {197, 224, 260},
          },
          std::array<Option<8>, puzzle.allPossibilities().size()>{
              Option<8>{0, 9, 18, 27, 36, 162, 189, 279}, {1, 10, 19, 28, 37, 163, 190, 280},
              {2, 11, 20, 29, 38, 164, 191, 281},         {3, 12, 21, 30, 39, 165, 192, 282},
              {4, 13, 22, 31, 40, 166, 193, 283},         {5, 14, 23, 32, 41, 167, 194, 284},
              {6, 15, 24, 33, 42, 168, 195, 285},         {7, 16, 25, 34, 43, 169, 196, 286},
              {8, 17, 26, 35, 44, 170, 197, 287},         {36, 45, 54, 63, 72, 171, 198, 225},
              {37, 46, 55, 64, 73, 172, 199, 226},        {38, 47, 56, 65, 74, 173, 200, 227},
              {39, 48, 57, 66, 75, 174, 201, 228},        {40, 49, 58, 67, 76, 175, 202, 229},
              {41, 50, 59, 68, 77, 176, 203, 230},        {42, 51, 60, 69, 78, 177, 204, 231},
              {43, 52, 61, 70, 79, 178, 205, 232},        {44, 53, 62, 71, 80, 179, 206, 233},
              {72, 81, 90, 99, 108, 207, 234, 261},       {73, 82, 91, 100, 109, 208, 235, 262},
              {74, 83, 92, 101, 110, 209, 236, 263},      {75, 84, 93, 102, 111, 210, 237, 264},
              {76, 85, 94, 103, 112, 211, 238, 265},      {77, 86, 95, 104, 113, 212, 239, 266},
              {78, 87, 96, 105, 114, 213, 240, 267},      {79, 88, 97, 106, 115, 214, 241, 268},
              {80, 89, 98, 107, 116, 215, 242, 269},      {0, 108, 117, 126, 135, 153, 243, 270},
              {1, 109, 118, 127, 136, 154, 244, 271},     {2, 110, 119, 128, 137, 155, 245, 272},
              {3, 111, 120, 129, 138, 156, 246, 273},     {4, 112, 121, 130, 139, 157, 247, 274},
              {5, 113, 122, 131, 140, 158, 248, 275},     {6, 114, 123, 132, 141, 159, 249, 276},
              {7, 115, 124, 133, 142, 160, 250, 277},     {8, 116, 125, 134, 143, 161, 251, 278},
              {144, 153, 162, 171, 180, 306, 333, 423},   {145, 154, 163, 172, 181, 307, 334, 424},
              {146, 155, 164, 173, 182, 308, 335, 425},   {147, 156, 165, 174, 183, 309, 336, 426},
              {148, 157, 166, 175, 184, 310, 337, 427},   {149, 158, 167, 176, 185, 311, 338, 428},
              {150, 159, 168, 177, 186, 312, 339, 429},   {151, 160, 169, 178, 187, 313, 340, 430},
              {152, 161, 170, 179, 188, 314, 341, 431},   {180, 189, 198, 207, 216, 315, 342, 369},
              {181, 190, 199, 208, 217, 316, 343, 370},   {182, 191, 200, 209, 218, 317, 344, 371},
              {183, 192, 201, 210, 219, 318, 345, 372},   {184, 193, 202, 211, 220, 319, 346, 373},
              {185, 194, 203, 212, 221, 320, 347, 374},   {186, 195, 204, 213, 222, 321, 348, 375},
              {187, 196, 205, 214, 223, 322, 349, 376},   {188, 197, 206, 215, 224, 323, 350, 377},
              {216, 225, 234, 243, 252, 351, 378, 405},   {217, 226, 235, 244, 253, 352, 379, 406},
              {218, 227, 236, 245, 254, 353, 380, 407},   {219, 228, 237, 246, 255, 354, 381, 408},
              {220, 229, 238, 247, 256, 355, 382, 409},   {221, 230, 239, 248, 257, 356, 383, 410},
              {222, 231, 240, 249, 258, 357, 384, 411},   {223, 232, 241, 250, 259, 358, 385, 412},
              {224, 233, 242, 251, 260, 359, 386, 413},   {144, 252, 261, 270, 279, 297, 387, 414},
              {145, 253, 262, 271, 280, 298, 388, 415},   {146, 254, 263, 272, 281, 299, 389, 416},
              {147, 255, 264, 273, 282, 300, 390, 417},   {148, 256, 265, 274, 283, 301, 391, 418},
              {149, 257, 266, 275, 284, 302, 392, 419},   {150, 258, 267, 276, 285, 303, 393, 420},
              {151, 259, 268, 277, 286, 304, 394, 421},   {152, 260, 269, 278, 287, 305, 395, 422},
              {18, 45, 135, 288, 297, 306, 315, 324},     {19, 46, 136, 289, 298, 307, 316, 325},
              {20, 47, 137, 290, 299, 308, 317, 326},     {21, 48, 138, 291, 300, 309, 318, 327},
              {22, 49, 139, 292, 301, 310, 319, 328},     {23, 50, 140, 293, 302, 311, 320, 329},
              {24, 51, 141, 294, 303, 312, 321, 330},     {25, 52, 142, 295, 304, 313, 322, 331},
              {26, 53, 143, 296, 305, 314, 323, 332},     {27, 54, 81, 324, 333, 342, 351, 360},
              {28, 55, 82, 325, 334, 343, 352, 361},      {29, 56, 83, 326, 335, 344, 353, 362},
              {30, 57, 84, 327, 336, 345, 354, 363},      {31, 58, 85, 328, 337, 346, 355, 364},
              {32, 59, 86, 329, 338, 347, 356, 365},      {33, 60, 87, 330, 339, 348, 357, 366},
              {34, 61, 88, 331, 340, 349, 358, 367},      {35, 62, 89, 332, 341, 350, 359, 368},
              {63, 90, 117, 360, 369, 378, 387, 396},     {64, 91, 118, 361, 370, 379, 388, 397},
              {65, 92, 119, 362, 371, 380, 389, 398},     {66, 93, 120, 363, 372, 381, 390, 399},
              {67, 94, 121, 364, 373, 382, 391, 400},     {68, 95, 122, 365, 374, 383, 392, 401},
              {69, 96, 123, 366, 375, 384, 393, 402},     {70, 97, 124, 367, 376, 385, 394, 403},
              {71, 98, 125, 368, 377, 386, 395, 404},     {9, 99, 126, 288, 396, 405, 414, 423},
              {10, 100, 127, 289, 397, 406, 415, 424},    {11, 101, 128, 290, 398, 407, 416, 425},
              {12, 102, 129, 291, 399, 408, 417, 426},    {13, 103, 130, 292, 400, 409, 418, 427},
              {14, 104, 131, 293, 401, 410, 419, 428},    {15, 105, 132, 294, 402, 411, 420, 429},
              {16, 106, 133, 295, 403, 412, 421, 430},    {17, 107, 134, 296, 404, 413, 422, 431},
          });
    }

    SUBCASE("Knight Pattern") {
      check<puzzle, 8>(
          std::array<std::pair<int32_t, int32_t>, 8>{
              std::make_pair(2, -1), {1, -2}, {-1, -2}, {-2, -1}, {-2, 1}, {-1, 2}, {1, 2}, {2, 1}},
          std::array<std::pair<int32_t, int32_t>, 4>{std::make_pair(1, 2), {2, 1}, {2, -1}, {1, -2}},
          std::array<std::size_t, 12>{0, 2, 5, 8, 10, 11, 12, 13, 14, 14, 14, 14},
          std::array<Option<8>, puzzle.allPossibilities().size()>{
              Option<8>{0, 9}, {1, 10},       {2, 11},       {3, 12},       {4, 13},       {5, 14},       {6, 15},
              {7, 16},         {8, 17},       {18, 27, 36},  {19, 28, 37},  {20, 29, 38},  {21, 30, 39},  {22, 31, 40},
              {23, 32, 41},    {24, 33, 42},  {25, 34, 43},  {26, 35, 44},  {45, 54, 63},  {46, 55, 64},  {47, 56, 65},
              {48, 57, 66},    {49, 58, 67},  {50, 59, 68},  {51, 60, 69},  {52, 61, 70},  {53, 62, 71},  {72, 81},
              {73, 82},        {74, 83},      {75, 84},      {76, 85},      {77, 86},      {78, 87},      {79, 88},
              {80, 89},        {63, 90},      {64, 91},      {65, 92},      {66, 93},      {67, 94},      {68, 95},
              {69, 96},        {70, 97},      {71, 98},      {81, 99},      {82, 100},     {83, 101},     {84, 102},
              {85, 103},       {86, 104},     {87, 105},     {88, 106},     {89, 107},     {0, 108},      {1, 109},
              {2, 110},        {3, 111},      {4, 112},      {5, 113},      {6, 114},      {7, 115},      {8, 116},
              {18, 117},       {19, 118},     {20, 119},     {21, 120},     {22, 121},     {23, 122},     {24, 123},
              {25, 124},       {26, 125},     {36, 108},     {37, 109},     {38, 110},     {39, 111},     {40, 112},
              {41, 113},       {42, 114},     {43, 115},     {44, 116},     {9, 54, 117},  {10, 55, 118}, {11, 56, 119},
              {12, 57, 120},   {13, 58, 121}, {14, 59, 122}, {15, 60, 123}, {16, 61, 124}, {17, 62, 125}, {27, 72, 90},
              {28, 73, 91},    {29, 74, 92},  {30, 75, 93},  {31, 76, 94},  {32, 77, 95},  {33, 78, 96},  {34, 79, 97},
              {35, 80, 98},    {45, 99},      {46, 100},     {47, 101},     {48, 102},     {49, 103},     {50, 104},
              {51, 105},       {52, 106},     {53, 107},
          },
          std::array<Option<8>, puzzle.allPossibilities().size()>{
              Option<8>{0, 9, 18, 27, 216, 243, 333, 414}, {1, 10, 19, 28, 217, 244, 334, 415},
              {2, 11, 20, 29, 218, 245, 335, 416},         {3, 12, 21, 30, 219, 246, 336, 417},
              {4, 13, 22, 31, 220, 247, 337, 418},         {5, 14, 23, 32, 221, 248, 338, 419},
              {6, 15, 24, 33, 222, 249, 339, 420},         {7, 16, 25, 34, 223, 250, 340, 421},
              {8, 17, 26, 35, 224, 251, 341, 422},         {36, 45, 54, 63, 252, 279, 306, 369},
              {37, 46, 55, 64, 253, 280, 307, 370},        {38, 47, 56, 65, 254, 281, 308, 371},
              {39, 48, 57, 66, 255, 282, 309, 372},        {40, 49, 58, 67, 256, 283, 310, 373},
              {41, 50, 59, 68, 257, 284, 311, 374},        {42, 51, 60, 69, 258, 285, 312, 375},
              {43, 52, 61, 70, 259, 286, 313, 376},        {44, 53, 62, 71, 260, 287, 314, 377},
              {72, 81, 90, 99, 144, 171, 342, 405},        {73, 82, 91, 100, 145, 172, 343, 406},
              {74, 83, 92, 101, 146, 173, 344, 407},       {75, 84, 93, 102, 147, 174, 345, 408},
              {76, 85, 94, 103, 148, 175, 346, 409},       {77, 86, 95, 104, 149, 176, 347, 410},
              {78, 87, 96, 105, 150, 177, 348, 411},       {79, 88, 97, 106, 151, 178, 349, 412},
              {80, 89, 98, 107, 152, 179, 350, 413},       {108, 117, 126, 135, 180, 207, 297, 378},
              {109, 118, 127, 136, 181, 208, 298, 379},    {110, 119, 128, 137, 182, 209, 299, 380},
              {111, 120, 129, 138, 183, 210, 300, 381},    {112, 121, 130, 139, 184, 211, 301, 382},
              {113, 122, 131, 140, 185, 212, 302, 383},    {114, 123, 132, 141, 186, 213, 303, 384},
              {115, 124, 133, 142, 187, 214, 304, 385},    {116, 125, 134, 143, 188, 215, 305, 386},
              {45, 126, 144, 153, 162, 171, 360, 387},     {46, 127, 145, 154, 163, 172, 361, 388},
              {47, 128, 146, 155, 164, 173, 362, 389},     {48, 129, 147, 156, 165, 174, 363, 390},
              {49, 130, 148, 157, 166, 175, 364, 391},     {50, 131, 149, 158, 167, 176, 365, 392},
              {51, 132, 150, 159, 168, 177, 366, 393},     {52, 133, 151, 160, 169, 178, 367, 394},
              {53, 134, 152, 161, 170, 179, 368, 395},     {18, 81, 180, 189, 198, 207, 396, 423},
              {19, 82, 181, 190, 199, 208, 397, 424},      {20, 83, 182, 191, 200, 209, 398, 425},
              {21, 84, 183, 192, 201, 210, 399, 426},      {22, 85, 184, 193, 202, 211, 400, 427},
              {23, 86, 185, 194, 203, 212, 401, 428},      {24, 87, 186, 195, 204, 213, 402, 429},
              {25, 88, 187, 196, 205, 214, 403, 430},      {26, 89, 188, 197, 206, 215, 404, 431},
              {54, 117, 216, 225, 234, 243, 288, 315},     {55, 118, 217, 226, 235, 244, 289, 316},
              {56, 119, 218, 227, 236, 245, 290, 317},     {57, 120, 219, 228, 237, 246, 291, 318},
              {58, 121, 220, 229, 238, 247, 292, 319},     {59, 122, 221, 230, 239, 248, 293, 320},
              {60, 123, 222, 231, 240, 249, 294, 321},     {61, 124, 223, 232, 241, 250, 295, 322},
              {62, 125, 224, 233, 242, 251, 296, 323},     {9, 90, 252, 261, 270, 279, 324, 351},
              {10, 91, 253, 262, 271, 280, 325, 352},      {11, 92, 254, 263, 272, 281, 326, 353},
              {12, 93, 255, 264, 273, 282, 327, 354},      {13, 94, 256, 265, 274, 283, 328, 355},
              {14, 95, 257, 266, 275, 284, 329, 356},      {15, 96, 258, 267, 276, 285, 330, 357},
              {16, 97, 259, 268, 277, 286, 331, 358},      {17, 98, 260, 269, 278, 287, 332, 359},
              {72, 99, 189, 270, 288, 297, 306, 315},      {73, 100, 190, 271, 289, 298, 307, 316},
              {74, 101, 191, 272, 290, 299, 308, 317},     {75, 102, 192, 273, 291, 300, 309, 318},
              {76, 103, 193, 274, 292, 301, 310, 319},     {77, 104, 194, 275, 293, 302, 311, 320},
              {78, 105, 195, 276, 294, 303, 312, 321},     {79, 106, 196, 277, 295, 304, 313, 322},
              {80, 107, 197, 278, 296, 305, 314, 323},     {108, 135, 162, 225, 324, 333, 342, 351},
              {109, 136, 163, 226, 325, 334, 343, 352},    {110, 137, 164, 227, 326, 335, 344, 353},
              {111, 138, 165, 228, 327, 336, 345, 354},    {112, 139, 166, 229, 328, 337, 346, 355},
              {113, 140, 167, 230, 329, 338, 347, 356},    {114, 141, 168, 231, 330, 339, 348, 357},
              {115, 142, 169, 232, 331, 340, 349, 358},    {116, 143, 170, 233, 332, 341, 350, 359},
              {0, 27, 198, 261, 360, 369, 378, 387},       {1, 28, 199, 262, 361, 370, 379, 388},
              {2, 29, 200, 263, 362, 371, 380, 389},       {3, 30, 201, 264, 363, 372, 381, 390},
              {4, 31, 202, 265, 364, 373, 382, 391},       {5, 32, 203, 266, 365, 374, 383, 392},
              {6, 33, 204, 267, 366, 375, 384, 393},       {7, 34, 205, 268, 367, 376, 385, 394},
              {8, 35, 206, 269, 368, 377, 386, 395},       {36, 63, 153, 234, 396, 405, 414, 423},
              {37, 64, 154, 235, 397, 406, 415, 424},      {38, 65, 155, 236, 398, 407, 416, 425},
              {39, 66, 156, 237, 399, 408, 417, 426},      {40, 67, 157, 238, 400, 409, 418, 427},
              {41, 68, 158, 239, 401, 410, 419, 428},      {42, 69, 159, 240, 402, 411, 420, 429},
              {43, 70, 160, 241, 403, 412, 421, 430},      {44, 71, 161, 242, 404, 413, 422, 431},
          });
    }

    SUBCASE("X Pattern") {
      check<puzzle, 4>(std::array<std::pair<int32_t, int32_t>, 4>{std::make_pair(0, -1), {0, 1}, {1, 0}, {-1, 0}},
                       std::array<std::pair<int32_t, int32_t>, 2>{std::make_pair(0, 1), {1, 0}},
                       std::array<std::size_t, 12>{0, 2, 4, 6, 7, 9, 11, 13, 14, 15, 16, 17},
                       std::array<Option<4>, puzzle.allPossibilities().size()>{
                           Option<4>{0, 9},
                           {1, 10},
                           {2, 11},
                           {3, 12},
                           {4, 13},
                           {5, 14},
                           {6, 15},
                           {7, 16},
                           {8, 17},
                           {0, 18, 27},
                           {1, 19, 28},
                           {2, 20, 29},
                           {3, 21, 30},
                           {4, 22, 31},
                           {5, 23, 32},
                           {6, 24, 33},
                           {7, 25, 34},
                           {8, 26, 35},
                           {18, 36, 45},
                           {19, 37, 46},
                           {20, 38, 47},
                           {21, 39, 48},
                           {22, 40, 49},
                           {23, 41, 50},
                           {24, 42, 51},
                           {25, 43, 52},
                           {26, 44, 53},
                           {36, 54},
                           {37, 55},
                           {38, 56},
                           {39, 57},
                           {40, 58},
                           {41, 59},
                           {42, 60},
                           {43, 61},
                           {44, 62},
                           {9, 63, 72},
                           {10, 64, 73},
                           {11, 65, 74},
                           {12, 66, 75},
                           {13, 67, 76},
                           {14, 68, 77},
                           {15, 69, 78},
                           {16, 70, 79},
                           {17, 71, 80},
                           {27, 63, 81, 90},
                           {28, 64, 82, 91},
                           {29, 65, 83, 92},
                           {30, 66, 84, 93},
                           {31, 67, 85, 94},
                           {32, 68, 86, 95},
                           {33, 69, 87, 96},
                           {34, 70, 88, 97},
                           {35, 71, 89, 98},
                           {45, 81, 99, 108},
                           {46, 82, 100, 109},
                           {47, 83, 101, 110},
                           {48, 84, 102, 111},
                           {49, 85, 103, 112},
                           {50, 86, 104, 113},
                           {51, 87, 105, 114},
                           {52, 88, 106, 115},
                           {53, 89, 107, 116},
                           {54, 99, 117},
                           {55, 100, 118},
                           {56, 101, 119},
                           {57, 102, 120},
                           {58, 103, 121},
                           {59, 104, 122},
                           {60, 105, 123},
                           {61, 106, 124},
                           {62, 107, 125},
                           {72, 126},
                           {73, 127},
                           {74, 128},
                           {75, 129},
                           {76, 130},
                           {77, 131},
                           {78, 132},
                           {79, 133},
                           {80, 134},
                           {90, 126, 135},
                           {91, 127, 136},
                           {92, 128, 137},
                           {93, 129, 138},
                           {94, 130, 139},
                           {95, 131, 140},
                           {96, 132, 141},
                           {97, 133, 142},
                           {98, 134, 143},
                           {108, 135, 144},
                           {109, 136, 145},
                           {110, 137, 146},
                           {111, 138, 147},
                           {112, 139, 148},
                           {113, 140, 149},
                           {114, 141, 150},
                           {115, 142, 151},
                           {116, 143, 152},
                           {117, 144},
                           {118, 145},
                           {119, 146},
                           {120, 147},
                           {121, 148},
                           {122, 149},
                           {123, 150},
                           {124, 151},
                           {125, 152},
                       },
                       std::array<Option<4>, puzzle.allPossibilities().size()>{
                           Option<4>{0, 9, 18, 81}, {1, 10, 19, 82},      {2, 11, 20, 83},      {3, 12, 21, 84},
                           {4, 13, 22, 85},         {5, 14, 23, 86},      {6, 15, 24, 87},      {7, 16, 25, 88},
                           {8, 17, 26, 89},         {18, 27, 36, 99},     {19, 28, 37, 100},    {20, 29, 38, 101},
                           {21, 30, 39, 102},       {22, 31, 40, 103},    {23, 32, 41, 104},    {24, 33, 42, 105},
                           {25, 34, 43, 106},       {26, 35, 44, 107},    {36, 45, 54, 117},    {37, 46, 55, 118},
                           {38, 47, 56, 119},       {39, 48, 57, 120},    {40, 49, 58, 121},    {41, 50, 59, 122},
                           {42, 51, 60, 123},       {43, 52, 61, 124},    {44, 53, 62, 125},    {0, 54, 63, 135},
                           {1, 55, 64, 136},        {2, 56, 65, 137},     {3, 57, 66, 138},     {4, 58, 67, 139},
                           {5, 59, 68, 140},        {6, 60, 69, 141},     {7, 61, 70, 142},     {8, 62, 71, 143},
                           {72, 81, 90, 153},       {73, 82, 91, 154},    {74, 83, 92, 155},    {75, 84, 93, 156},
                           {76, 85, 94, 157},       {77, 86, 95, 158},    {78, 87, 96, 159},    {79, 88, 97, 160},
                           {80, 89, 98, 161},       {90, 99, 108, 171},   {91, 100, 109, 172},  {92, 101, 110, 173},
                           {93, 102, 111, 174},     {94, 103, 112, 175},  {95, 104, 113, 176},  {96, 105, 114, 177},
                           {97, 106, 115, 178},     {98, 107, 116, 179},  {108, 117, 126, 189}, {109, 118, 127, 190},
                           {110, 119, 128, 191},    {111, 120, 129, 192}, {112, 121, 130, 193}, {113, 122, 131, 194},
                           {114, 123, 132, 195},    {115, 124, 133, 196}, {116, 125, 134, 197}, {72, 126, 135, 207},
                           {73, 127, 136, 208},     {74, 128, 137, 209},  {75, 129, 138, 210},  {76, 130, 139, 211},
                           {77, 131, 140, 212},     {78, 132, 141, 213},  {79, 133, 142, 214},  {80, 134, 143, 215},
                           {9, 144, 153, 162},      {10, 145, 154, 163},  {11, 146, 155, 164},  {12, 147, 156, 165},
                           {13, 148, 157, 166},     {14, 149, 158, 167},  {15, 150, 159, 168},  {16, 151, 160, 169},
                           {17, 152, 161, 170},     {27, 162, 171, 180},  {28, 163, 172, 181},  {29, 164, 173, 182},
                           {30, 165, 174, 183},     {31, 166, 175, 184},  {32, 167, 176, 185},  {33, 168, 177, 186},
                           {34, 169, 178, 187},     {35, 170, 179, 188},  {45, 180, 189, 198},  {46, 181, 190, 199},
                           {47, 182, 191, 200},     {48, 183, 192, 201},  {49, 184, 193, 202},  {50, 185, 194, 203},
                           {51, 186, 195, 204},     {52, 187, 196, 205},  {53, 188, 197, 206},  {63, 144, 198, 207},
                           {64, 145, 199, 208},     {65, 146, 200, 209},  {66, 147, 201, 210},  {67, 148, 202, 211},
                           {68, 149, 203, 212},     {69, 150, 204, 213},  {70, 151, 205, 214},  {71, 152, 206, 215},
                       });
    }

    SUBCASE("X Pattern Large") {
      check<puzzle, 8>(
          std::array<std::pair<int32_t, int32_t>, 8>{
              std::make_pair(1, -1), {2, -2}, {-1, -1}, {-2, -2}, {-1, 1}, {-2, 2}, {1, 1}, {2, 2}},
          std::array<std::pair<int32_t, int32_t>, 4>{std::make_pair(1, 1), {2, 2}, {1, -1}, {2, -2}},
          std::array<std::size_t, 12>{0, 2, 5, 8, 10, 11, 13, 15, 16, 16, 16, 16},
          std::array<Option<8>, puzzle.allPossibilities().size()>{
              Option<8>{0, 9},
              {1, 10},
              {2, 11},
              {3, 12},
              {4, 13},
              {5, 14},
              {6, 15},
              {7, 16},
              {8, 17},
              {18, 27, 36},
              {19, 28, 37},
              {20, 29, 38},
              {21, 30, 39},
              {22, 31, 40},
              {23, 32, 41},
              {24, 33, 42},
              {25, 34, 43},
              {26, 35, 44},
              {45, 54, 63},
              {46, 55, 64},
              {47, 56, 65},
              {48, 57, 66},
              {49, 58, 67},
              {50, 59, 68},
              {51, 60, 69},
              {52, 61, 70},
              {53, 62, 71},
              {72, 81},
              {73, 82},
              {74, 83},
              {75, 84},
              {76, 85},
              {77, 86},
              {78, 87},
              {79, 88},
              {80, 89},
              {36, 90},
              {37, 91},
              {38, 92},
              {39, 93},
              {40, 94},
              {41, 95},
              {42, 96},
              {43, 97},
              {44, 98},
              {0, 54, 99, 108},
              {1, 55, 100, 109},
              {2, 56, 101, 110},
              {3, 57, 102, 111},
              {4, 58, 103, 112},
              {5, 59, 104, 113},
              {6, 60, 105, 114},
              {7, 61, 106, 115},
              {8, 62, 107, 116},
              {18, 72, 117, 126},
              {19, 73, 118, 127},
              {20, 74, 119, 128},
              {21, 75, 120, 129},
              {22, 76, 121, 130},
              {23, 77, 122, 131},
              {24, 78, 123, 132},
              {25, 79, 124, 133},
              {26, 80, 125, 134},
              {45, 135},
              {46, 136},
              {47, 137},
              {48, 138},
              {49, 139},
              {50, 140},
              {51, 141},
              {52, 142},
              {53, 143},
              {63, 108},
              {64, 109},
              {65, 110},
              {66, 111},
              {67, 112},
              {68, 113},
              {69, 114},
              {70, 115},
              {71, 116},
              {81, 90, 126},
              {82, 91, 127},
              {83, 92, 128},
              {84, 93, 129},
              {85, 94, 130},
              {86, 95, 131},
              {87, 96, 132},
              {88, 97, 133},
              {89, 98, 134},
              {9, 99, 135},
              {10, 100, 136},
              {11, 101, 137},
              {12, 102, 138},
              {13, 103, 139},
              {14, 104, 140},
              {15, 105, 141},
              {16, 106, 142},
              {17, 107, 143},
              {27, 117},
              {28, 118},
              {29, 119},
              {30, 120},
              {31, 121},
              {32, 122},
              {33, 123},
              {34, 124},
              {35, 125},
          },
          std::array<Option<8>, puzzle.allPossibilities().size()>{
              Option<8>{0, 9, 18, 27, 180, 270, 369, 387}, {1, 10, 19, 28, 181, 271, 370, 388},
              {2, 11, 20, 29, 182, 272, 371, 389},         {3, 12, 21, 30, 183, 273, 372, 390},
              {4, 13, 22, 31, 184, 274, 373, 391},         {5, 14, 23, 32, 185, 275, 374, 392},
              {6, 15, 24, 33, 186, 276, 375, 393},         {7, 16, 25, 34, 187, 277, 376, 394},
              {8, 17, 26, 35, 188, 278, 377, 395},         {36, 45, 54, 63, 162, 216, 405, 423},
              {37, 46, 55, 64, 163, 217, 406, 424},        {38, 47, 56, 65, 164, 218, 407, 425},
              {39, 48, 57, 66, 165, 219, 408, 426},        {40, 49, 58, 67, 166, 220, 409, 427},
              {41, 50, 59, 68, 167, 221, 410, 428},        {42, 51, 60, 69, 168, 222, 411, 429},
              {43, 52, 61, 70, 169, 223, 412, 430},        {44, 53, 62, 71, 170, 224, 413, 431},
              {72, 81, 90, 99, 198, 252, 297, 315},        {73, 82, 91, 100, 199, 253, 298, 316},
              {74, 83, 92, 101, 200, 254, 299, 317},       {75, 84, 93, 102, 201, 255, 300, 318},
              {76, 85, 94, 103, 202, 256, 301, 319},       {77, 86, 95, 104, 203, 257, 302, 320},
              {78, 87, 96, 105, 204, 258, 303, 321},       {79, 88, 97, 106, 205, 259, 304, 322},
              {80, 89, 98, 107, 206, 260, 305, 323},       {108, 117, 126, 135, 144, 234, 333, 351},
              {109, 118, 127, 136, 145, 235, 334, 352},    {110, 119, 128, 137, 146, 236, 335, 353},
              {111, 120, 129, 138, 147, 237, 336, 354},    {112, 121, 130, 139, 148, 238, 337, 355},
              {113, 122, 131, 140, 149, 239, 338, 356},    {114, 123, 132, 141, 150, 240, 339, 357},
              {115, 124, 133, 142, 151, 241, 340, 358},    {116, 125, 134, 143, 152, 242, 341, 359},
              {81, 99, 144, 153, 162, 171, 324, 414},      {82, 100, 145, 154, 163, 172, 325, 415},
              {83, 101, 146, 155, 164, 173, 326, 416},     {84, 102, 147, 156, 165, 174, 327, 417},
              {85, 103, 148, 157, 166, 175, 328, 418},     {86, 104, 149, 158, 167, 176, 329, 419},
              {87, 105, 150, 159, 168, 177, 330, 420},     {88, 106, 151, 160, 169, 178, 331, 421},
              {89, 107, 152, 161, 170, 179, 332, 422},     {117, 135, 180, 189, 198, 207, 306, 360},
              {118, 136, 181, 190, 199, 208, 307, 361},    {119, 137, 182, 191, 200, 209, 308, 362},
              {120, 138, 183, 192, 201, 210, 309, 363},    {121, 139, 184, 193, 202, 211, 310, 364},
              {122, 140, 185, 194, 203, 212, 311, 365},    {123, 141, 186, 195, 204, 213, 312, 366},
              {124, 142, 187, 196, 205, 214, 313, 367},    {125, 143, 188, 197, 206, 215, 314, 368},
              {9, 27, 216, 225, 234, 243, 342, 396},       {10, 28, 217, 226, 235, 244, 343, 397},
              {11, 29, 218, 227, 236, 245, 344, 398},      {12, 30, 219, 228, 237, 246, 345, 399},
              {13, 31, 220, 229, 238, 247, 346, 400},      {14, 32, 221, 230, 239, 248, 347, 401},
              {15, 33, 222, 231, 240, 249, 348, 402},      {16, 34, 223, 232, 241, 250, 349, 403},
              {17, 35, 224, 233, 242, 251, 350, 404},      {45, 63, 252, 261, 270, 279, 288, 378},
              {46, 64, 253, 262, 271, 280, 289, 379},      {47, 65, 254, 263, 272, 281, 290, 380},
              {48, 66, 255, 264, 273, 282, 291, 381},      {49, 67, 256, 265, 274, 283, 292, 382},
              {50, 68, 257, 266, 275, 284, 293, 383},      {51, 69, 258, 267, 276, 285, 294, 384},
              {52, 70, 259, 268, 277, 286, 295, 385},      {53, 71, 260, 269, 278, 287, 296, 386},
              {36, 126, 225, 243, 288, 297, 306, 315},     {37, 127, 226, 244, 289, 298, 307, 316},
              {38, 128, 227, 245, 290, 299, 308, 317},     {39, 129, 228, 246, 291, 300, 309, 318},
              {40, 130, 229, 247, 292, 301, 310, 319},     {41, 131, 230, 248, 293, 302, 311, 320},
              {42, 132, 231, 249, 294, 303, 312, 321},     {43, 133, 232, 250, 295, 304, 313, 322},
              {44, 134, 233, 251, 296, 305, 314, 323},     {18, 72, 261, 279, 324, 333, 342, 351},
              {19, 73, 262, 280, 325, 334, 343, 352},      {20, 74, 263, 281, 326, 335, 344, 353},
              {21, 75, 264, 282, 327, 336, 345, 354},      {22, 76, 265, 283, 328, 337, 346, 355},
              {23, 77, 266, 284, 329, 338, 347, 356},      {24, 78, 267, 285, 330, 339, 348, 357},
              {25, 79, 268, 286, 331, 340, 349, 358},      {26, 80, 269, 287, 332, 341, 350, 359},
              {54, 108, 153, 171, 360, 369, 378, 387},     {55, 109, 154, 172, 361, 370, 379, 388},
              {56, 110, 155, 173, 362, 371, 380, 389},     {57, 111, 156, 174, 363, 372, 381, 390},
              {58, 112, 157, 175, 364, 373, 382, 391},     {59, 113, 158, 176, 365, 374, 383, 392},
              {60, 114, 159, 177, 366, 375, 384, 393},     {61, 115, 160, 178, 367, 376, 385, 394},
              {62, 116, 161, 179, 368, 377, 386, 395},     {0, 90, 189, 207, 396, 405, 414, 423},
              {1, 91, 190, 208, 397, 406, 415, 424},       {2, 92, 191, 209, 398, 407, 416, 425},
              {3, 93, 192, 210, 399, 408, 417, 426},       {4, 94, 193, 211, 400, 409, 418, 427},
              {5, 95, 194, 212, 401, 410, 419, 428},       {6, 96, 195, 213, 402, 411, 420, 429},
              {7, 97, 196, 214, 403, 412, 421, 430},       {8, 98, 197, 215, 404, 413, 422, 431},
          });
    }
  }

  SUBCASE("Pattern Validation") {
    // Valid Moore
    CHECK(NeighborPatternUtilities::isValidPattern(std::array<std::pair<int32_t, int32_t>, 8>{
        std::make_pair(1, 0), {1, -1}, {0, -1}, {-1, -1}, {-1, 0}, {-1, 1}, {0, 1}, {1, 1}}));
    // Valid Plus
    CHECK(NeighborPatternUtilities::isValidPattern(
        std::array<std::pair<int32_t, int32_t>, 4>{std::make_pair(0, -1), {0, 1}, {1, 0}, {-1, 0}}));

    // Invalid Moore (one offset invalidates radial symmetry)
    CHECK_FALSE(NeighborPatternUtilities::isValidPattern(std::array<std::pair<int32_t, int32_t>, 8>{
        std::make_pair(1, 0), {1, -1}, {0, -1}, {-1, -1}, {-1, 0}, {-1, 1}, {0, 1}, {2, 0}}));
    // Invalid Moore (two are duplicate)
    CHECK_FALSE(NeighborPatternUtilities::isValidPattern(std::array<std::pair<int32_t, int32_t>, 8>{
        std::make_pair(1, 0), {1, -1}, {0, -1}, {-1, -1}, {-1, 0}, {-1, -1}, {-1, 0}}));
    // Invalid pattern (non-radially-symmetric)
    CHECK_FALSE(NeighborPatternUtilities::isValidPattern(
        std::array<std::pair<int32_t, int32_t>, 2>{std::make_pair(1, 0), {1, -1}}));
  }
}
